<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPKBIS Showcase Judge Login</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .view { display: none; }
        .view.active { display: block; }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        .online-indicator {
            height: 10px;
            width: 10px;
            background-color: #22c55e; /* green-500 */
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        /* Style for draggable items */
        .presenter-item {
            cursor: grab;
            transition: background-color 0.2s;
        }
        .presenter-item:active {
            cursor: grabbing;
        }
        /* Judge sidebar styles */
        .sidebar-item {
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .sidebar-item:hover {
            background-color: #eef2ff; /* indigo-50 */
        }
        .sidebar-item.active-card {
            background-color: #c7d2fe; /* indigo-300 */
            font-weight: 600;
        }
        /* Sticky sidebar for judge view */
        @media (min-width: 768px) {
            #judge-sidebar-wrapper {
                position: sticky;
                top: 100px; /* Adjust based on header height */
                max-height: calc(100vh - 120px);
                overflow-y: auto;
            }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <div id="login-view" class="view active">
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl mt-16">
                <div class="p-8">
                    <h1 class="text-3xl font-bold text-center text-gray-900 mb-2">PPKBIS Showcase Judge Login</h1>
                    <p class="text-center text-gray-500 mb-8">Select your role and session to continue</p>
                    <form id="login-form">
                        <div class="mb-6">
                            <label for="username" class="block mb-2 text-sm font-medium text-gray-900">Your Name (e.g., Judge 1)</label>
                            <input type="text" id="username" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="Enter your name" required>
                        </div>
                        <div class="mb-6">
                            <label for="role" class="block mb-2 text-sm font-medium text-gray-900">Select Role</label>
                            <select id="role" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                <option value="judge">Judge</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div id="session-field" class="mb-6">
                            <label for="session" class="block mb-2 text-sm font-medium text-gray-900">Select Session</label>
                            <select id="session" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                <option value="Session 1 (Poster)">Session 1 (Poster)</option>
                                <option value="Session 2 (Oral)">Session 2 (Oral)</option>
                                <option value="Session 3 (Workshop)">Session 3 (Workshop)</option>
                                <option value="Session 4 (Poster)">Session 4 (Poster)</option>
                            </select>
                        </div>
                        <div id="admin-password-field" class="mb-6" style="display: none;">
                            <label for="password" class="block mb-2 text-sm font-medium text-gray-900">Admin Password</label>
                            <input type="password" id="password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="•••••••••">
                        </div>
                        <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Login</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="admin-view" class="view">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Admin Dashboard</h1>
                <button id="admin-logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Add Presenter</h2>
                        <form id="add-candidate-form" class="space-y-4">
                            <input type="text" id="candidate-name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" placeholder="Presenter Name" required>
                            <select id="candidate-session" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" required>
                                <option value="" disabled selected>Select Session</option>
                                <option value="Session 1 (Poster)">Session 1 (Poster)</option>
                                <option value="Session 2 (Oral)">Session 2 (Oral)</option>
                                <option value="Session 3 (Workshop)">Session 3 (Workshop)</option>
                                <option value="Session 4 (Poster)">Session 4 (Poster)</option>
                            </select>
                            <select id="candidate-category" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" disabled>
                                <option value="Poster">Poster Presentation</option>
                                <option value="Oral">Oral Presentation</option>
                                <option value="Workshop">Workshop</option>
                            </select>
                            <input type="number" id="candidate-order" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" placeholder="Order (e.g., 1, 2, 3)" required min="1">
                            <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5">Add Presenter</button>
                        </form>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Presenter List (Drag to Rearrange)</h2>
                        <div id="admin-candidate-list" class="space-y-6"></div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Judges Online</h2>
                        <div id="judges-online-list" class="space-y-3"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                           <h2 class="text-2xl font-semibold mb-4">System Controls</h2>
                           <button id="reset-button" class="w-full text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5">Reset All Scores</button>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Grand Winner & Category Awards</h2>
                        <div id="winners-board" class="space-y-8">
                            </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Live Rankings (All Presenters)</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50" id="rankings-header">
                                    </thead>
                                <tbody id="rankings-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Detailed Scores & Feedback</h2>
                        <div id="feedback-details-board" class="space-y-6">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="judge-view" class="view">
             <header class="flex justify-between items-center mb-8">
                <h1 id="judge-header" class="text-4xl font-bold text-gray-900">Judge Panel</h1>
                <div class="flex items-center space-x-4">
                    <p id="current-session-display" class="text-xl font-semibold text-indigo-600"></p>
                    <button id="judge-logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
                </div>
            </header>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div id="judge-sidebar-wrapper" class="md:col-span-1 bg-white p-4 rounded-xl shadow-md space-y-4">
                    <div class="space-y-1">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Presenter List</h3>
                        <div id="judge-sidebar-list" class="space-y-1">
                            <p class="text-gray-500 text-sm">Loading...</p>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <button id="final-submit-button" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 disabled:opacity-50" disabled>
                            Confirm All Scores
                        </button>
                    </div>
                </div>

                <div class="md:col-span-3">
                    <div id="judge-presenter-card" class="bg-white p-8 rounded-xl shadow-2xl">
                        <p class="text-center text-gray-500 text-xl" id="judge-status-message">Loading next presenter...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-title">Confirm Action</h3>
            <div class="mt-2"><p class="text-sm text-gray-500" id="modal-message">Are you sure?</p></div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button id="modal-confirm-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:col-start-2 sm:text-sm">Confirm</button>
                <button id="modal-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:col-start-1 sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        document.addEventListener("DOMContentLoaded", () => {
            const firebaseApp = "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            const firebaseAuth = "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            const firebaseFirestore = "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            Promise.all([
                import(firebaseApp),
                import(firebaseAuth),
                import(firebaseFirestore)
            ]).then((modules) => {
                const { initializeApp } = modules[0];
                const { getAuth, signInAnonymously, signInWithCustomToken } = modules[1];
                const { getFirestore, doc, setDoc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp, writeBatch, getDocs, getDoc, query, where, orderBy } = modules[2];

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ppkbis-judging-default';
                
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config)
                    : {
                        apiKey: "AIzaSyDCTebeG42Vj1G9TRIApiLhwfsxng5mP0Y",
                        authDomain: "ppkbis-shell.firebaseapp.com",
                        projectId: "ppkbis-shell",
                        storageBucket: "ppkbis-shell.firebasestorage.app",
                        messagingSenderId: "942093342515",
                        appId: "1:942093342515:web:29a844b91ba357835a9046",
                        measurementId: "G-M5Q9NCD7JF"
                      };

                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                (async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else { await signInAnonymously(auth); }
                    const userId = auth.currentUser?.uid || `anonymous-${crypto.randomUUID()}`;

                    const SESSION_CATEGORY_MAP = {
                        'Session 1 (Poster)': 'Poster',
                        'Session 2 (Oral)': 'Oral',
                        'Session 3 (Workshop)': 'Workshop',
                        'Session 4 (Poster)': 'Poster'
                    };
                    const CATEGORIES = {
                        'Poster': [
                            { name: 'Content & Relevance', max: 35, desc: 'Clear coverage of 5 sections; relevant to ELT.' },
                            { name: 'Organisation & Clarity', max: 20, desc: 'Logical flow, concise writing, easy to follow.' },
                            { name: 'Visual Design & Layout', max: 20, desc: 'Layout, size compliance, clear fonts, balanced visuals.' },
                            { name: 'Engagement & Communication', max: 25, desc: 'Presenter explains poster confidently & interacts.' }
                        ],
                        'Oral': [
                            { name: 'Content & Relevance', max: 35, desc: 'Clear coverage of 5 sections, relevant to ELT.' },
                            { name: 'Organisation & Clarity', max: 20, desc: 'Logical sequence, smooth flow, well-timed.' },
                            { name: 'Slide Design', max: 15, desc: 'Professional layout, readability, effective visuals.' },
                            { name: 'Delivery & Engagement', max: 30, desc: 'Clear speech, confidence, manages Q&A well, engages audience.' }
                        ],
                        'Workshop': [
                            { name: 'Content & Relevance', max: 35, desc: '5 sections covered, practical & relevant to ELT.' },
                            { name: 'Organisation & Facilitation', max: 20, desc: 'Clear structure, smooth transitions, time control.' },
                            { name: 'Engagement & Interaction', max: 25, desc: 'Active participant involvement, inclusive facilitation.' },
                            { name: 'Resources & Materials', max: 20, desc: 'Quality & usefulness of handouts/slides/materials.' }
                        ]
                    };
                    const CATEGORY_NAMES = Object.keys(CATEGORIES);
                    const FIXED_JUDGE_COUNT = 3;

                    let currentUser = null;
                    let unsubscribeCandidates = () => {};
                    let unsubscribeScores = () => {};
                    let unsubscribePresence = () => {};
                    let presenceInterval = null;
                    
                    // Unified state for Admin Dashboard
                    let adminCandidates = [];
                    let adminScores = [];
                    let adminFeedbacks = [];
                    
                    // Judge state variables
                    let currentJudgeSession = null;
                    let allJudgeCandidates = [];
                    let allJudgeScores = {};
                    let isSubmittingScore = false; 
                    let currentPresenterId = null; 

                    const views = { login: document.getElementById('login-view'), admin: document.getElementById('admin-view'), judge: document.getElementById('judge-view') };

                    function showView(viewName) {
                        Object.values(views).forEach(view => view.classList.remove('active'));
                        if (views[viewName]) views[viewName].classList.add('active');
                    }

                    function updateCategoryDropdown(sessionValue) {
                        const category = SESSION_CATEGORY_MAP[sessionValue] || 'Poster';
                        const categorySelect = document.getElementById('candidate-category');
                        if (categorySelect) {
                            categorySelect.value = category;
                        }
                    }

                    async function handleLogin(e) {
                        e.preventDefault();
                        const username = document.getElementById('username').value.trim();
                        const role = document.getElementById('role').value;
                        const session = document.getElementById('session').value;
                        if (!username) { alert("Please enter your name."); return; }
                        if (role === 'judge' && !session) { alert("Please select a session."); return; }

                        if (role === 'admin') {
                            const password = document.getElementById('password').value;
                            if (password !== 'admin123') {
                                alert('Incorrect admin password.');
                                return;
                            }
                        }
                        
                        currentJudgeSession = role === 'judge' ? session : null;
                        
                        currentUser = { id: `${username.replace(/\s+/g, '-')}-${userId.substring(0,4)}`, name: username, role, session: currentJudgeSession };
                        
                        if (role === 'admin') { 
                            showView('admin'); 
                            initAdminView(); 
                        } else { 
                            document.getElementById('judge-header').textContent = `Judge Panel - ${currentUser.name}`;
                            document.getElementById('current-session-display').textContent = `Session: ${currentJudgeSession}`;
                            const presenceRef = doc(db, `artifacts/${appId}/public/data/presence`, currentUser.id);
                            const updatePresence = () => setDoc(presenceRef, { name: currentUser.name, lastSeen: serverTimestamp() });
                            await updatePresence();
                            presenceInterval = setInterval(updatePresence, 20000); 
                            showView('judge'); 
                            initJudgeView(); 
                        }
                    }

                    async function handleLogout() {
                        if (currentUser.role === 'judge') {
                            clearInterval(presenceInterval);
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/presence`, currentUser.id));
                        }
                        unsubscribeCandidates();
                        unsubscribeScores();
                        unsubscribePresence();
                        currentUser = null;
                        currentJudgeSession = null;
                        currentPresenterId = null;
                        document.getElementById('username').value = '';
                        document.getElementById('session').value = 'Session 1 (Poster)';
                        showView('login');
                    }

                    // --- ADMIN VIEW LOGIC ---

                    function initAdminView() {
                        unsubscribeCandidates = onSnapshot(query(collection(db, `artifacts/${appId}/public/data/candidates`), orderBy("session"), orderBy("orderIndex")), async (candidateSnapshot) => {
                            adminCandidates = candidateSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            
                            const [scoreSnapshot, feedbackSnapshot] = await Promise.all([
                                getDocs(collection(db, `artifacts/${appId}/public/data/scores`)),
                                getDocs(collection(db, `artifacts/${appId}/public/data/feedback`))
                            ]);
                            
                            adminScores = scoreSnapshot.docs.map(d => d.data());
                            adminFeedbacks = feedbackSnapshot.docs.map(d => d.data());
                            
                            renderAdminCandidateList(adminCandidates);
                            calculateAndDisplayResults(adminCandidates, adminScores, adminFeedbacks);
                        });

                        unsubscribeScores = onSnapshot(collection(db, `artifacts/${appId}/public/data/scores`), async (scoreSnapshot) => {
                            if (adminCandidates.length === 0) return;

                            adminScores = scoreSnapshot.docs.map(d => d.data());
                            
                            const feedbackSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/feedback`));
                            adminFeedbacks = feedbackSnapshot.docs.map(d => d.data());

                            calculateAndDisplayResults(adminCandidates, adminScores, adminFeedbacks);
                        });
                        
                        unsubscribePresence = onSnapshot(collection(db, `artifacts/${appId}/public/data/presence`), (snapshot) => {
                            renderOnlineJudges(snapshot.docs);
                        });
                    }
                    
                    async function handleAddCandidate(e) {
                        e.preventDefault();
                        const candidateNameInput = document.getElementById('candidate-name');
                        const candidateName = candidateNameInput.value.trim();
                        const session = document.getElementById('candidate-session').value;
                        const order = parseInt(document.getElementById('candidate-order').value, 10);
                        
                        if (!candidateName || !session || isNaN(order)) { 
                            alert("Please fill all fields correctly."); 
                            return; 
                        }

                        const category = SESSION_CATEGORY_MAP[session];
                        const orderIndex = order;

                        const existing = adminCandidates.find(c => c.session === session && c.orderIndex === orderIndex);
                        if (existing) {
                            alert(`Order number ${orderIndex} already exists in ${session}. Please use a different number.`);
                            return;
                        }
                        
                        try {
                            const tempId = `temp-${Date.now()}`;
                            const newCandidate = { id: tempId, name: candidateName, session: session, category: category, orderIndex: orderIndex };
                            
                            const updatedCandidates = [...adminCandidates, newCandidate].sort((a, b) => {
                                if (a.session !== b.session) return a.session.localeCompare(b.session);
                                return a.orderIndex - b.orderIndex;
                            });
                            renderAdminCandidateList(updatedCandidates);
                            
                            await addDoc(collection(db, `artifacts/${appId}/public/data/candidates`), { 
                                name: candidateName, 
                                session: session,
                                category: category,
                                orderIndex: orderIndex
                            });

                            candidateNameInput.value = '';
                            document.getElementById('candidate-order').value = '';

                        } catch (error) {
                            console.error("Error adding candidate:", error);
                            alert("Error adding presenter. Check console for details.");
                            renderAdminCandidateList(adminCandidates);
                        }
                    }

                    async function deleteCandidate(candidateId) {
                        if (await showConfirmationModal('Delete Presenter', `This will delete the presenter and ALL associated scores and feedback. Are you sure?`)) {
                            const batch = writeBatch(db);

                            batch.delete(doc(db, `artifacts/${appId}/public/data/candidates`, candidateId));

                            const scoresQuery = query(collection(db, `artifacts/${appId}/public/data/scores`), where("candidateId", "==", candidateId));
                            const scoresSnapshot = await getDocs(scoresQuery);
                            scoresSnapshot.docs.forEach(d => batch.delete(d.ref));

                            const feedbackSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/feedback`));
                            feedbackSnapshot.docs.forEach(d => {
                                if (d.data().candidateId === candidateId || d.id.startsWith(`${candidateId}_`)) {
                                    batch.delete(d.ref);
                                }
                            });

                            await batch.commit();
                        }
                    }
                    
                    async function handlePresenterReorder(evt) {
                        if (evt.from !== evt.to) { return; } 
                        
                        const listEl = evt.from;
                        const newOrder = Array.from(listEl.children).map(item => item.dataset.id);

                        const batch = writeBatch(db);
                        
                        newOrder.forEach((candidateId, index) => {
                            const newOrderIndex = index + 1;
                            const candidateRef = doc(db, `artifacts/${appId}/public/data/candidates`, candidateId);
                            batch.update(candidateRef, { orderIndex: newOrderIndex });
                        });

                        try {
                            await batch.commit();
                        } catch (error) {
                            console.error("Error committing batch reorder:", error);
                            alert("Failed to save new order. Please try again.");
                        }
                    }

                    function initSortableLists() {
                        document.querySelectorAll('.sortable-session-list').forEach(list => {
                            if (list.sortable) {
                                list.sortable.destroy();
                            }
                            
                            list.sortable = Sortable.create(list, {
                                animation: 150,
                                ghostClass: 'bg-indigo-100',
                                handle: '.drag-handle',
                                group: {
                                    name: 'sessions',
                                    pull: false, 
                                    put: false
                                },
                                onEnd: handlePresenterReorder,
                            });
                        });
                    }
                    
                    function renderAdminCandidateList(candidates) {
                        const listEl = document.getElementById('admin-candidate-list');
                        if(!listEl) return;
                        listEl.innerHTML = '';

                        if (candidates.length === 0) {
                            listEl.innerHTML = '<p class="text-gray-500">No presenters added yet.</p>';
                            return;
                        }
                        
                        const sessions = {};
                        candidates.forEach(c => {
                            const sessionKey = c.session || 'Unassigned Session';
                            if (!sessions[sessionKey]) sessions[sessionKey] = [];
                            sessions[sessionKey].push(c);
                        });

                        const sessionKeys = Object.keys(sessions).sort();

                        sessionKeys.forEach(sessionKey => {
                            const sessionGroup = document.createElement('div');
                            sessionGroup.className = 'mb-4 border-b border-indigo-200 pb-2';
                            sessionGroup.innerHTML = `<h4 class="text-lg font-semibold text-indigo-700 mb-2">${sessionKey}</h4>`;
                            
                            const ulList = document.createElement('ul');
                            ulList.className = 'space-y-1 sortable-session-list';
                            ulList.id = `sortable-${sessionKey.replace(/\W/g, '-')}`;
                            ulList.dataset.session = sessionKey;

                            sessions[sessionKey].forEach(c => {
                                const isTemporary = c.id.startsWith('temp-');
                                
                                const li = document.createElement('li');
                                li.className = `presenter-item bg-gray-50 hover:bg-gray-100 rounded-lg shadow-sm ${isTemporary ? 'opacity-70' : ''}`;
                                li.dataset.id = c.id;
                                li.dataset.session = c.session;

                                li.innerHTML = `<div class="flex justify-between items-center p-2">
                                    <div class="flex items-center space-x-3 drag-handle text-gray-400 hover:text-gray-600 cursor-grab">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M10 3a1 1 0 011 1v2a1 1 0 11-2 0V4a1 1 0 011-1zM7 7a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zM4 11a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM7 15a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zM10 18a1 1 0 011-1v2a1 1 0 11-2 0v-2a1 1 0 011 1z"/>
                                        </svg>
                                        <span class="text-sm font-medium text-gray-900">${c.orderIndex || '-'}. ${c.name}</span>
                                        <span class="ml-2 text-xs text-gray-600 bg-gray-200 px-2 py-1 rounded-full">${c.category}</span>
                                        ${isTemporary ? '<span class="ml-2 text-xs text-red-600 bg-red-100 px-2 py-1 rounded-full">Saving...</span>' : ''}
                                    </div>
                                    <button data-id="${c.id}" class="delete-candidate-btn text-red-500 hover:text-red-700 text-xs font-bold ${isTemporary ? 'opacity-50 cursor-not-allowed' : ''}" ${isTemporary ? 'disabled' : ''}>DELETE</button>
                                </div>`;
                                
                                ulList.appendChild(li);
                            });

                            sessionGroup.appendChild(ulList);
                            listEl.appendChild(sessionGroup);
                        });

                        initSortableLists();

                        document.querySelectorAll('.delete-candidate-btn').forEach(btn => btn.onclick = (e) => {
                            if (!e.target.disabled) deleteCandidate(btn.dataset.id);
                        });
                    }
                    
                    function calculateAndDisplayResults(candidates, scores, feedbacks) {
                        const judges = [...new Set(scores.map(s => s.judgeName))].sort();
                        
                        let results = candidates.map(c => {
                            const scoresByJudge = {};
                            judges.forEach(j => {
                                const judgeScores = scores.filter(s => s.candidateId === c.id && s.judgeName === j);
                                scoresByJudge[j] = judgeScores.reduce((sum, s) => sum + s.score, 0);
                            });
                            const totalScores = Object.values(scoresByJudge).filter(s => s > 0);
                            const judgeCount = totalScores.length;
                            const average = judgeCount > 0 ? totalScores.reduce((a, b) => a + b, 0) / judgeCount : 0;
                            return { ...c, scoresByJudge, average: parseFloat(average.toFixed(2)), judgeCount, award: '-' };
                        });

                        const fullyJudged = results.filter(r => r.judgeCount === FIXED_JUDGE_COUNT);
                        
                        const winnerMap = new Map();
                        const categoryWinners = {};
                        
                        CATEGORY_NAMES.forEach(cat => {
                            const catResults = fullyJudged.filter(r => r.category === cat);
                            const gold = catResults.filter(r => r.average >= 85).sort((a,b) => b.average - a.average);
                            const silver = catResults.filter(r => r.average >= 70 && r.average < 85).sort((a,b) => b.average - a.average);
                            const bronze = catResults.filter(r => r.average >= 55 && r.average < 70).sort((a,b) => b.average - a.average);
                            
                            categoryWinners[cat] = { gold, silver, bronze };
                            
                            [...gold, ...silver, ...bronze].forEach(r => {
                                if (r.average >= 85) winnerMap.set(r.id, {level: 'Gold', class: 'bg-yellow-400 text-white'});
                                else if (r.average >= 70) winnerMap.set(r.id, {level: 'Silver', class: 'bg-gray-400 text-white'});
                                else if (r.average >= 55) winnerMap.set(r.id, {level: 'Bronze', class: 'bg-yellow-600 text-white'});
                            });
                        });
                        
                        results.forEach(r => {
                            if(winnerMap.has(r.id)) r.award = winnerMap.get(r.id).level;
                        });

                        const rankings = results.sort((a, b) => b.average - a.average);

                        // --- Render Winner Board ---
                        const winnersBoard = document.getElementById('winners-board');
                        if(!winnersBoard) return;
                        winnersBoard.innerHTML = '';
                        
                        // 1. Grand Winner Section
                        const overallRanking = fullyJudged.sort((a,b) => b.average - a.average);
                        const grandWinner = overallRanking.length > 0 ? overallRanking[0] : null;

                        let grandWinnerHTML = `<div class="text-center p-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg mb-8">
                            <h3 class="text-2xl font-bold text-white uppercase tracking-wider">Overall Grand Winner (Highest Average Score)</h3>`;
                        if (grandWinner) {
                            grandWinnerHTML += `<p class="text-4xl font-extrabold text-white mt-2">${grandWinner.name} (${grandWinner.category})</p>
                                <p class="text-lg font-medium text-indigo-100">Overall Score: ${grandWinner.average.toFixed(2)}</p>`;
                        } else {
                            grandWinnerHTML += `<p class="text-xl font-semibold text-white mt-2">- Awaiting ${FIXED_JUDGE_COUNT} scores -</p>`;
                        }
                        grandWinnerHTML += `</div>`;
                        winnersBoard.innerHTML += grandWinnerHTML;
                        
                        // 2. Category Winners Section (Separate Cards)
                        winnersBoard.innerHTML += `<h3 class="text-xl font-bold text-gray-900 mb-4">Winners by Category (Minimum ${FIXED_JUDGE_COUNT} Judges)</h3>`;
                        
                        const categoryCardContainer = document.createElement('div');
                        categoryCardContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';

                        CATEGORY_NAMES.forEach(cat => {
                            const catData = categoryWinners[cat];
                            
                            const renderCategoryTier = (title, winners, colorClass) => {
                                let html = `<div class="mt-2"><p class="font-medium text-sm text-gray-700">${title} (${winners.length}):</p>`;
                                if (winners.length > 0) {
                                    html += `<div class="flex flex-wrap gap-2 pt-1">` + winners.map(w =>
                                        `<span class="px-3 py-1 text-xs font-semibold rounded-full ${colorClass} text-white">${w.name} (${w.average.toFixed(2)})</span>`
                                    ).join('') + `</div>`;
                                } else {
                                    html += `<p class="text-xs text-gray-500 italic">None finalized.</p>`;
                                }
                                html += `</div>`;
                                return html;
                            };

                            let categoryHTML = `<div class="bg-gray-100 p-4 rounded-lg shadow-sm h-full flex flex-col">
                                <h4 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2">${cat}</h4>
                                ${renderCategoryTier('Gold (>=85)', catData.gold, 'bg-yellow-600')}
                                ${renderCategoryTier('Silver (70-84)', catData.silver, 'bg-gray-500')}
                                ${renderCategoryTier('Bronze (55-69)', catData.bronze, 'bg-amber-700')}
                            </div>`;
                            
                            categoryCardContainer.innerHTML += categoryHTML;
                        });
                        winnersBoard.appendChild(categoryCardContainer);


                        // --- Render Rankings Table ---
                        const tableHeader = document.getElementById('rankings-header');
                        if(!tableHeader) return;
                        tableHeader.innerHTML = `<tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Presenter</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session/Category</th>
                            ${judges.map(j => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${j}</th>`).join('')}
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judges Submitted</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Award</th>
                        </tr>`;
                        
                        const rankingsBody = document.getElementById('rankings-body');
                        if(!rankingsBody) return;
                        rankingsBody.innerHTML = '';
                        rankings.forEach(r => {
                            const awardInfo = winnerMap.get(r.id);
                            let awardClass = 'bg-gray-200 text-gray-800';
                            if (awardInfo) {
                                awardClass = awardInfo.level === 'Gold' ? 'bg-yellow-400 text-white' : 
                                             (awardInfo.level === 'Silver' ? 'bg-gray-400 text-white' : 'bg-yellow-600 text-white');
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium">${r.orderIndex ? `${r.orderIndex}. ` : ''}${r.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.session || r.category}</td>
                                ${judges.map(j => `<td class="px-6 py-4 whitespace-nowrap text-sm">${r.scoresByJudge[j] || '-'}</td>`).join('')}
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-medium">${r.judgeCount} / ${FIXED_JUDGE_COUNT}</td>
                                <td class="px-6 py-4 whitespace-nowrap font-bold">${r.average.toFixed(2)}</td>
                                <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${awardClass}">${r.award}</span></td>`;
                            rankingsBody.appendChild(row);
                        });

                        // --- Render Detailed Feedback Board ---
                        const feedbackBoard = document.getElementById('feedback-details-board');
                        if(!feedbackBoard) return;
                        feedbackBoard.innerHTML = '';

                        const judgeMap = new Map();
                        scores.forEach(s => { if (!judgeMap.has(s.judgeId)) judgeMap.set(s.judgeId, s.judgeName) });

                        const augmentedFeedbacks = feedbacks.map(f => ({ ...f, judgeName: judgeMap.get(f.judgeId) || 'Unknown' }));

                        if (rankings.length === 0) {
                            feedbackBoard.innerHTML = '<p class="text-gray-500">No presenters have been scored yet.</p>';
                        } else {
                            rankings.forEach(candidate => {
                                const feedbackForCandidate = augmentedFeedbacks.filter(f => f.candidateId === candidate.id);
                                const judgesWhoScored = Object.keys(candidate.scoresByJudge).filter(j => candidate.scoresByJudge[j] > 0);

                                let candidateFeedbackHTML = `<div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-lg font-bold text-indigo-700">${candidate.orderIndex ? `${candidate.orderIndex}. ` : ''}${candidate.name}</h3><div class="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

                                if (judgesWhoScored.length > 0) {
                                    judgesWhoScored.forEach(judgeName => {
                                        const judgeFeedback = feedbackForCandidate.find(f => f.judgeName === judgeName);
                                        const feedbackText = (judgeFeedback && judgeFeedback.feedbackText) ? judgeFeedback.feedbackText : 'No feedback submitted.';
                                        
                                        candidateFeedbackHTML += `<div class="bg-white p-3 rounded-md shadow-sm">
                                            <div class="flex justify-between items-center border-b pb-2 mb-2">
                                                <p class="font-semibold text-gray-800">${judgeName}</p>
                                                <p class="font-bold text-gray-600">Score: ${candidate.scoresByJudge[judgeName]}</p>
                                            </div>
                                            <p class="text-sm text-gray-600 italic">"${feedbackText}"</p>
                                        </div>`;
                                    });
                                } else {
                                    candidateFeedbackHTML += `<p class="text-sm text-gray-500 col-span-full">No scores or feedback submitted yet for this presenter.</p>`;
                                }
                                candidateFeedbackHTML += `</div></div>`;
                                feedbackBoard.innerHTML += candidateFeedbackHTML;
                            });
                        }
                    }
                    
                    // --- JUDGE VIEW LOGIC ---

                    function initJudgeView() {
                        // Listener for all candidates (sorted by session and order)
                        unsubscribeCandidates = onSnapshot(query(collection(db, `artifacts/${appId}/public/data/candidates`), orderBy("session"), orderBy("orderIndex")), (snapshot) => {
                            allJudgeCandidates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderJudgeSidebar();
                            
                            // If no card is loaded yet, load the next unscored one.
                            if (!currentPresenterId) {
                                renderNextJudgeCard();
                            } else {
                                // If a card is loaded, re-render it to ensure fresh data
                                renderNextJudgeCard(currentPresenterId);
                            }
                        });

                        // Listener for only the current judge's scores
                        const judgeScoresQuery = query(collection(db, `artifacts/${appId}/public/data/scores`), where("judgeId", "==", currentUser.id));
                        unsubscribeScores = onSnapshot(judgeScoresQuery, (snapshot) => {
                            allJudgeScores = snapshot.docs.map(d => d.data()).reduce((acc, s) => {
                                acc[s.candidateId] = acc[s.candidateId] || 0;
                                acc[s.candidateId] += s.score;
                                return acc;
                            }, {});
                            
                            renderJudgeSidebar();
                            
                            // Only force a UI update if not currently submitting, to prevent jumpiness
                            if (!isSubmittingScore) {
                                // If the current card was scored/updated, find the next unscored and load it.
                                if (currentPresenterId) {
                                    const unscored = getNextCandidate(allJudgeCandidates, allJudgeScores);
                                    
                                    // If current card is fully scored and there's a next unscored, navigate.
                                    if (unscored && unscored.id !== currentPresenterId && allJudgeScores[currentPresenterId] > 0) {
                                        renderNextJudgeCard(unscored.id);
                                    } else if (currentPresenterId) {
                                        // Otherwise, stay on the currently loaded card (either to finish scoring or show completion)
                                        renderNextJudgeCard(currentPresenterId);
                                    }
                                }
                            }
                        });
                        
                        document.getElementById('final-submit-button').onclick = confirmFinalSubmission;
                    }
                    
                    async function confirmFinalSubmission() {
                        const allSessionCandidates = allJudgeCandidates.filter(c => c.session === currentJudgeSession);
                        const unscoredCount = allSessionCandidates.filter(c => !allJudgeScores[c.id] || allJudgeScores[c.id] === 0).length;

                        if (unscoredCount > 0) {
                            alert(`You still have ${unscoredCount} presenter(s) with pending scores. Please complete all scores before final submission.`);
                            return;
                        }

                        if (await showConfirmationModal('Final Score Submission', 'Are you absolutely sure you want to finalize and submit ALL scores for this session? This action is permanent.')) {
                            const finalDocRef = doc(db, `artifacts/${appId}/public/data/final_submissions`, `${currentUser.id}_${currentJudgeSession}`);
                            await setDoc(finalDocRef, {
                                judgeId: currentUser.id,
                                judgeName: currentUser.name,
                                session: currentJudgeSession,
                                timestamp: serverTimestamp(),
                                status: 'FINALIZED'
                            });
                            
                            alert('Scores finalized successfully! Thank you for judging.');
                            renderJudgeSidebar();
                        }
                    }

                    function renderJudgeSidebar() {
                        const sidebarList = document.getElementById('judge-sidebar-list');
                        const finalSubmitButton = document.getElementById('final-submit-button');
                        if (!sidebarList || !finalSubmitButton) return;

                        const sessionCandidates = allJudgeCandidates
                            .filter(c => c.session === currentJudgeSession)
                            .sort((a, b) => a.orderIndex - b.orderIndex);

                        const totalCandidates = sessionCandidates.length;
                        const scoredCount = sessionCandidates.filter(c => allJudgeScores[c.id] > 0).length;
                        const allScored = totalCandidates > 0 && scoredCount === totalCandidates;

                        sidebarList.innerHTML = sessionCandidates.map(c => {
                            const isScored = allJudgeScores[c.id] > 0;
                            const isCurrent = c.id === currentPresenterId;
                            const statusClass = isScored ? 'text-green-600' : 'text-yellow-600';
                            const statusText = isScored ? 'SCORED' : 'PENDING';
                            
                            return `<div data-id="${c.id}" class="sidebar-item ${isCurrent ? 'active-card' : 'text-gray-700'} p-2 rounded-lg text-sm flex justify-between items-center">
                                <span>${c.orderIndex}. ${c.name}</span>
                                <span class="text-xs ${statusClass} font-semibold">${statusText}</span>
                            </div>`;
                        }).join('');

                        // Enable/Disable Final Submit button
                        finalSubmitButton.disabled = !allScored;
                        finalSubmitButton.textContent = allScored 
                            ? `Confirm All Scores (${scoredCount}/${totalCandidates})` 
                            : `Pending (${totalCandidates - scoredCount}) - Cannot Confirm`;

                        document.querySelectorAll('.sidebar-item').forEach(item => {
                            item.onclick = () => renderNextJudgeCard(item.dataset.id);
                        });
                    }


                    function getNextCandidate(candidates, scores) {
                        const sessionCandidates = candidates.filter(c => c.session === currentJudgeSession);
                        
                        const unscoredCandidate = sessionCandidates
                            .sort((a, b) => a.orderIndex - b.orderIndex)
                            .find(c => !scores[c.id] || scores[c.id] === 0);
                        
                        return unscoredCandidate || null;
                    }

                    function renderNextJudgeCard(candidateId = null) {
                        const container = document.getElementById('judge-presenter-card');
                        if (!container) return;
                        
                        let candidate;
                        if (candidateId) {
                            candidate = allJudgeCandidates.find(c => c.id === candidateId);
                        } else {
                            candidate = getNextCandidate(allJudgeCandidates, allJudgeScores);
                        }

                        if (!candidate) {
                            container.innerHTML = `<p class="text-center text-green-600 text-2xl font-bold mt-4">Session Complete!</p>
                                <p class="text-center text-gray-600 text-md mt-2">You have submitted scores for all ${currentJudgeSession} presenters. You may now confirm your final scores.</p>`;
                            currentPresenterId = null;
                            renderJudgeSidebar();
                            return;
                        }
                        
                        currentPresenterId = candidate.id;

                        const criteria = CATEGORIES[candidate.category];
                        const maxTotal = criteria.reduce((sum, crit) => sum + crit.max, 0);

                        const isScored = allJudgeScores[candidate.id] > 0;
                        const submitButtonText = isScored ? 'Update Scores & Proceed to Next' : 'Submit Scores & Next Presenter';
                        const cardClass = isScored ? 'border-4 border-yellow-500 shadow-xl' : 'shadow-2xl';
                        
                        const criteriaHTML = criteria.map(crit => {
                            const fieldId = `score-${candidate.id}-${crit.name.replace(/\W/g, '-')}`;
                            return `<div class="space-y-1">
                                <div class="flex justify-between items-center">
                                    <label for="${fieldId}" class="text-sm font-medium text-gray-800">${crit.name} (Max: ${crit.max})</label>
                                    <input type="number" id="${fieldId}" name="${crit.name}" data-max="${crit.max}" min="0" max="${crit.max}" class="score-input w-20 text-center bg-gray-50 border border-gray-300 text-sm rounded-lg p-1.5" required>
                                </div>
                                <p class="text-xs text-gray-500">${crit.desc}</p>
                            </div>`;
                        }).join('');

                        container.className = `bg-white p-8 rounded-xl ${cardClass}`;
                        container.innerHTML = `
                            <h2 class="text-3xl font-bold mb-2">${candidate.orderIndex}. ${candidate.name}</h2>
                            <p class="text-lg text-indigo-600 font-semibold mb-6">${candidate.session} (${candidate.category})</p>
                            <form data-candidate-id="${candidate.id}" data-candidate-category="${candidate.category}" class="candidate-score-form space-y-4">
                                <div class="space-y-4">${criteriaHTML}</div>
                                <div class="text-right font-bold text-xl pt-4 border-t mt-4">Total: <span class="total-score">0</span> / ${maxTotal}</div>
                                <div class="mt-4 pt-4 border-t">
                                    <label for="feedback-${candidate.id}" class="block text-sm font-medium text-gray-700 mb-1">Feedback</label>
                                    <textarea id="feedback-${candidate.id}" rows="3" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2"></textarea>
                                </div>
                                <button type="submit" class="w-full mt-4 text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-base px-5 py-3">${submitButtonText}</button>
                            </form>`;
                        
                        populateJudgeCard(candidate.id, candidate.category, container);
                        renderJudgeSidebar();

                        container.querySelector('.candidate-score-form').addEventListener('submit', handleScoreSubmitAndNext);
                        container.querySelector('.candidate-score-form').addEventListener('input', e => {
                            if (e.target.classList.contains('score-input')) {
                                const input = e.target;
                                const max = parseInt(input.dataset.max, 10);
                                if (parseInt(input.value) > max) input.value = max;
                                if (parseInt(input.value) < 0) input.value = 0;
                                updateLiveTotal(e.target.closest('form'));
                            }
                        });
                    }

                    async function populateJudgeCard(candidateId, candidateCategory, container) {
                        const scoreDocsSnapshot = await getDocs(query(collection(db, `artifacts/${appId}/public/data/scores`), 
                            where("candidateId", "==", candidateId), 
                            where("judgeId", "==", currentUser.id)));
                        
                        const feedbackDocRef = doc(db, `artifacts/${appId}/public/data/feedback`, `${candidateId}_${currentUser.id}`);
                        const feedbackDocSnap = await getDoc(feedbackDocRef);

                        const form = container.querySelector(`form[data-candidate-id="${candidateId}"]`);
                        if (!form) return;

                        let currentTotal = 0;
                        const criteria = CATEGORIES[candidateCategory];

                        // Load previous scores
                        scoreDocsSnapshot.docs.forEach(d => {
                            const scoreData = d.data();
                            const input = form.querySelector(`[name="${scoreData.category}"]`);
                            if (input) {
                                input.value = scoreData.score;
                                currentTotal += scoreData.score;
                            }
                        });

                        // Load previous feedback
                        if (feedbackDocSnap.exists()) {
                            form.querySelector(`#feedback-${candidateId}`).value = feedbackDocSnap.data().feedbackText;
                        }
                        
                        form.querySelector('.total-score').textContent = currentTotal;
                        updateLiveTotal(form); 
                    }

                    async function handleScoreSubmitAndNext(e) {
                        e.preventDefault();
                        const form = e.target;
                        const candidateId = form.dataset.candidateId;
                        
                        if (isSubmittingScore) {
                            alert("Submission is already in progress. Please wait a moment.");
                            return;
                        }

                        isSubmittingScore = true;
                        
                        await handleScoreSubmit(e);
                        
                        setTimeout(() => {
                            isSubmittingScore = false;
                            
                            const currentTotal = parseInt(form.querySelector('.total-score').textContent, 10) || 0;
                            allJudgeScores[candidateId] = currentTotal;
                            
                            // Find the next unscored candidate
                            const unscored = getNextCandidate(allJudgeCandidates, allJudgeScores);
                            
                            if (unscored) {
                                renderNextJudgeCard(unscored.id);
                            } else {
                                // If all are scored, stay on the current card (which will show 'Session Complete')
                                renderNextJudgeCard(candidateId); 
                            }
                        }, 500); 
                    }

                    async function handleScoreSubmit(e) {
                        const form = e.target;
                        const button = form.querySelector('button[type="submit"]');
                        button.disabled = true;
                        button.textContent = 'Submitting...';

                        const candidateId = form.dataset.candidateId;
                        const batch = writeBatch(db);

                        form.querySelectorAll('.score-input').forEach(input => {
                            const category = input.name;
                            const score = parseInt(input.value, 10) || 0;
                            const scoreId = `${candidateId}-${currentUser.id}-${category.replace(/\W/g, '-')}`;
                            const scoreRef = doc(db, `artifacts/${appId}/public/data/scores`, scoreId);
                            batch.set(scoreRef, { candidateId, judgeId: currentUser.id, judgeName: currentUser.name, category, score });
                        });
                        
                        const feedbackText = form.querySelector('textarea').value;
                        const feedbackId = `${candidateId}_${currentUser.id}`;
                        const feedbackRef = doc(db, `artifacts/${appId}/public/data/feedback`, feedbackId);
                        batch.set(feedbackRef, { candidateId, judgeId: currentUser.id, feedbackText });

                        await batch.commit();
                        button.textContent = 'Submitted!';
                        setTimeout(() => {
                            button.disabled = false;
                        }, 500);
                    }

                    function updateLiveTotal(form) {
                           let total = 0;
                           form.querySelectorAll('.score-input').forEach(i => { total += parseInt(i.value, 10) || 0; });
                           form.querySelector('.total-score').textContent = total;
                    }

                    async function handleResetScores() {
                           if (await showConfirmationModal('Reset All Scores', 'This will delete ALL scores and feedback. This action is irreversible.')) {
                               const scoresSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/scores`));
                               const feedbackSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/feedback`));
                               const batch = writeBatch(db);
                               scoresSnapshot.docs.forEach(d => batch.delete(d.ref));
                               feedbackSnapshot.docs.forEach(d => batch.delete(d.ref));
                               await batch.commit();
                           }
                    }

                    function renderOnlineJudges(presenceDocs) {
                        const listEl = document.getElementById('judges-online-list');
                        if(!listEl) return;
                        listEl.innerHTML = '';
                        const now = Date.now();
                        presenceDocs.forEach(docSnap => {
                            const data = docSnap.data();
                            if (data.lastSeen && (now - data.lastSeen.toDate().getTime()) < 30000) {
                                const div = document.createElement('div');
                                div.className = 'flex items-center bg-gray-100 p-2 rounded-lg';
                                div.innerHTML = `<span class="online-indicator mr-3"></span><span class="font-medium text-gray-700">${data.name}</span>`;
                                listEl.appendChild(div);
                            }
                        });
                           if (!listEl.hasChildNodes()) {
                                listEl.innerHTML = '<p class="text-gray-500 text-sm">No judges currently online.</p>';
                            }
                    }

                    function showConfirmationModal(title, message) {
                        return new Promise((resolve) => {
                            const modal = document.getElementById('confirmation-modal');
                            modal.querySelector('#modal-title').textContent = title;
                            modal.querySelector('#modal-message').textContent = message;
                            modal.classList.add('active');
                            const confirmBtn = modal.querySelector('#modal-confirm-btn');
                            const cancelBtn = modal.querySelector('#modal-cancel-btn');
                            const close = (result) => {
                                modal.classList.remove('active');
                                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                                resolve(result);
                            };
                            modal.querySelector('#modal-confirm-btn').onclick = () => close(true);
                            modal.querySelector('#modal-cancel-btn').onclick = () => close(false);
                        });
                    }

                    function calculateAndDisplayResults(candidates, scores, feedbacks) {
                        const judges = [...new Set(scores.map(s => s.judgeName))].sort();
                        
                        let results = candidates.map(c => {
                            const scoresByJudge = {};
                            judges.forEach(j => {
                                const judgeScores = scores.filter(s => s.candidateId === c.id && s.judgeName === j);
                                scoresByJudge[j] = judgeScores.reduce((sum, s) => sum + s.score, 0);
                            });
                            const totalScores = Object.values(scoresByJudge).filter(s => s > 0);
                            const judgeCount = totalScores.length;
                            const average = judgeCount > 0 ? totalScores.reduce((a, b) => a + b, 0) / judgeCount : 0;
                            return { ...c, scoresByJudge, average: parseFloat(average.toFixed(2)), judgeCount, award: '-' };
                        });

                        const fullyJudged = results.filter(r => r.judgeCount === FIXED_JUDGE_COUNT);
                        
                        const winnerMap = new Map();
                        const categoryWinners = {};
                        
                        CATEGORY_NAMES.forEach(cat => {
                            const catResults = fullyJudged.filter(r => r.category === cat);
                            const gold = catResults.filter(r => r.average >= 85).sort((a,b) => b.average - a.average);
                            const silver = catResults.filter(r => r.average >= 70 && r.average < 85).sort((a,b) => b.average - a.average);
                            const bronze = catResults.filter(r => r.average >= 55 && r.average < 70).sort((a,b) => b.average - a.average);
                            
                            categoryWinners[cat] = { gold, silver, bronze };
                            
                            [...gold, ...silver, ...bronze].forEach(r => {
                                if (r.average >= 85) winnerMap.set(r.id, {level: 'Gold', class: 'bg-yellow-400 text-white'});
                                else if (r.average >= 70) winnerMap.set(r.id, {level: 'Silver', class: 'bg-gray-400 text-white'});
                                else if (r.average >= 55) winnerMap.set(r.id, {level: 'Bronze', class: 'bg-yellow-600 text-white'});
                            });
                        });
                        
                        results.forEach(r => {
                            if(winnerMap.has(r.id)) r.award = winnerMap.get(r.id).level;
                        });

                        const rankings = results.sort((a, b) => b.average - a.average);

                        // --- Render Winner Board ---
                        const winnersBoard = document.getElementById('winners-board');
                        if(!winnersBoard) return;
                        winnersBoard.innerHTML = '';
                        
                        // 1. Grand Winner Section
                        const overallRanking = fullyJudged.sort((a,b) => b.average - a.average);
                        const grandWinner = overallRanking.length > 0 ? overallRanking[0] : null;

                        let grandWinnerHTML = `<div class="text-center p-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg mb-8">
                            <h3 class="text-2xl font-bold text-white uppercase tracking-wider">Overall Grand Winner (Highest Average Score)</h3>`;
                        if (grandWinner) {
                            grandWinnerHTML += `<p class="text-4xl font-extrabold text-white mt-2">${grandWinner.name} (${grandWinner.category})</p>
                                <p class="text-lg font-medium text-indigo-100">Overall Score: ${grandWinner.average.toFixed(2)}</p>`;
                        } else {
                            grandWinnerHTML += `<p class="text-xl font-semibold text-white mt-2">- Awaiting ${FIXED_JUDGE_COUNT} scores -</p>`;
                        }
                        grandWinnerHTML += `</div>`;
                        winnersBoard.innerHTML += grandWinnerHTML;
                        
                        // 2. Category Winners Section (Separate Cards)
                        winnersBoard.innerHTML += `<h3 class="text-xl font-bold text-gray-900 mb-4">Winners by Category (Minimum ${FIXED_JUDGE_COUNT} Judges)</h3>`;
                        
                        const categoryCardContainer = document.createElement('div');
                        categoryCardContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';

                        CATEGORY_NAMES.forEach(cat => {
                            const catData = categoryWinners[cat];
                            
                            const renderCategoryTier = (title, winners, colorClass) => {
                                let html = `<div class="mt-2"><p class="font-medium text-sm text-gray-700">${title} (${winners.length}):</p>`;
                                if (winners.length > 0) {
                                    html += `<div class="flex flex-wrap gap-2 pt-1">` + winners.map(w =>
                                        `<span class="px-3 py-1 text-xs font-semibold rounded-full ${colorClass} text-white">${w.name} (${w.average.toFixed(2)})</span>`
                                    ).join('') + `</div>`;
                                } else {
                                    html += `<p class="text-xs text-gray-500 italic">None finalized.</p>`;
                                }
                                html += `</div>`;
                                return html;
                            };

                            let categoryHTML = `<div class="bg-gray-100 p-4 rounded-lg shadow-sm h-full flex flex-col">
                                <h4 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2">${cat}</h4>
                                ${renderCategoryTier('Gold (>=85)', catData.gold, 'bg-yellow-600')}
                                ${renderCategoryTier('Silver (70-84)', catData.silver, 'bg-gray-500')}
                                ${renderCategoryTier('Bronze (55-69)', catData.bronze, 'bg-amber-700')}
                            </div>`;
                            
                            categoryCardContainer.innerHTML += categoryHTML;
                        });
                        winnersBoard.appendChild(categoryCardContainer);


                        // --- Render Rankings Table ---
                        const tableHeader = document.getElementById('rankings-header');
                        if(!tableHeader) return;
                        tableHeader.innerHTML = `<tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Presenter</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session/Category</th>
                            ${judges.map(j => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${j}</th>`).join('')}
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judges Submitted</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Award</th>
                        </tr>`;
                        
                        const rankingsBody = document.getElementById('rankings-body');
                        if(!rankingsBody) return;
                        rankingsBody.innerHTML = '';
                        rankings.forEach(r => {
                            const awardInfo = winnerMap.get(r.id);
                            let awardClass = 'bg-gray-200 text-gray-800';
                            if (awardInfo) {
                                awardClass = awardInfo.level === 'Gold' ? 'bg-yellow-400 text-white' : 
                                             (awardInfo.level === 'Silver' ? 'bg-gray-400 text-white' : 'bg-yellow-600 text-white');
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium">${r.orderIndex ? `${r.orderIndex}. ` : ''}${r.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.session || r.category}</td>
                                ${judges.map(j => `<td class="px-6 py-4 whitespace-nowrap text-sm">${r.scoresByJudge[j] || '-'}</td>`).join('')}
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-medium">${r.judgeCount} / ${FIXED_JUDGE_COUNT}</td>
                                <td class="px-6 py-4 whitespace-nowrap font-bold">${r.average.toFixed(2)}</td>
                                <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${awardClass}">${r.award}</span></td>`;
                            rankingsBody.appendChild(row);
                        });

                        // --- Render Detailed Feedback Board ---
                        const feedbackBoard = document.getElementById('feedback-details-board');
                        if(!feedbackBoard) return;
                        feedbackBoard.innerHTML = '';

                        const judgeMap = new Map();
                        scores.forEach(s => { if (!judgeMap.has(s.judgeId)) judgeMap.set(s.judgeId, s.judgeName) });

                        const augmentedFeedbacks = feedbacks.map(f => ({ ...f, judgeName: judgeMap.get(f.judgeId) || 'Unknown' }));

                        if (rankings.length === 0) {
                            feedbackBoard.innerHTML = '<p class="text-gray-500">No presenters have been scored yet.</p>';
                        } else {
                            rankings.forEach(candidate => {
                                const feedbackForCandidate = augmentedFeedbacks.filter(f => f.candidateId === candidate.id);
                                const judgesWhoScored = Object.keys(candidate.scoresByJudge).filter(j => candidate.scoresByJudge[j] > 0);

                                let candidateFeedbackHTML = `<div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-lg font-bold text-indigo-700">${candidate.orderIndex ? `${candidate.orderIndex}. ` : ''}${candidate.name}</h3><div class="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

                                if (judgesWhoScored.length > 0) {
                                    judgesWhoScored.forEach(judgeName => {
                                        const judgeFeedback = feedbackForCandidate.find(f => f.judgeName === judgeName);
                                        const feedbackText = (judgeFeedback && judgeFeedback.feedbackText) ? judgeFeedback.feedbackText : 'No feedback submitted.';
                                        
                                        candidateFeedbackHTML += `<div class="bg-white p-3 rounded-md shadow-sm">
                                            <div class="flex justify-between items-center border-b pb-2 mb-2">
                                                <p class="font-semibold text-gray-800">${judgeName}</p>
                                                <p class="font-bold text-gray-600">Score: ${candidate.scoresByJudge[judgeName]}</p>
                                            </div>
                                            <p class="text-sm text-gray-600 italic">"${feedbackText}"</p>
                                        </div>`;
                                    });
                                } else {
                                    candidateFeedbackHTML += `<p class="text-sm text-gray-500 col-span-full">No scores or feedback submitted yet for this presenter.</p>`;
                                }
                                candidateFeedbackHTML += `</div></div>`;
                                feedbackBoard.innerHTML += candidateFeedbackHTML;
                            });
                        }
                    }
                    
                    // --- Event Listeners ---
                    document.getElementById('login-form').addEventListener('submit', handleLogin);
                    document.getElementById('role').addEventListener('change', (e) => {
                        const passwordField = document.getElementById('admin-password-field');
                        passwordField.style.display = e.target.value === 'admin' ? 'block' : 'none';
                        document.getElementById('session-field').style.display = e.target.value === 'judge' ? 'block' : 'none';
                    });
                    
                    const candidateSessionSelect = document.getElementById('candidate-session');
                    if(candidateSessionSelect) {
                        candidateSessionSelect.addEventListener('change', (e) => {
                            updateCategoryDropdown(e.target.value);
                        });
                        updateCategoryDropdown(candidateSessionSelect.value);
                    }

                    document.getElementById('add-candidate-form').addEventListener('submit', handleAddCandidate);
                    document.getElementById('reset-button').addEventListener('click', handleResetScores);
                    document.getElementById('admin-logout').addEventListener('click', handleLogout);
                    document.getElementById('judge-logout').addEventListener('click', handleLogout);
                    
                    showView('login');
                })();
            });
        });
    </script>
</body>
</html>